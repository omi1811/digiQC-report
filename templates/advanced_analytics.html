{% extends "base.html" %}
{% block title %}Advanced Analytics - digiQC Reports{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Hero Banner -->
    <div class="hero mb-4">
        <div class="d-flex align-items-center gap-3">
            <i class="bi bi-graph-up-arrow" style="font-size: 2.5rem;"></i>
            <div>
                <h1 class="h3 mb-1">Advanced Analytics</h1>
                <p class="lead mb-0">Deep insights: Overdue tracking, Repeat offenders, Post-approval issues</p>
            </div>
        </div>
    </div>

    <!-- File Status -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body d-flex align-items-center gap-3">
                    <i class="bi bi-file-earmark-spreadsheet text-primary" style="font-size: 1.5rem;"></i>
                    <div>
                        <div class="small text-muted">EQC File</div>
                        <div class="fw-semibold">{{ eqc_file or 'Not uploaded' }}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body d-flex align-items-center gap-3">
                    <i class="bi bi-file-earmark-text text-warning" style="font-size: 1.5rem;"></i>
                    <div>
                        <div class="small text-muted">Issues File</div>
                        <div class="fw-semibold">{{ issues_file or 'Not uploaded' }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Cards -->
    <div class="row g-4">
        <!-- Overdue Issues -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-danger text-white">
                    <i class="bi bi-alarm me-2"></i>Overdue Issues Dashboard
                </div>
                <div class="card-body">
                    <p class="card-text text-muted">Track issues that have passed their deadline. Grouped by team, type,
                        and location.</p>
                    <button class="btn btn-danger" id="btnOverdue" {% if not issues_file %}disabled{% endif %}>
                        <span class="spinner-border spinner-border-sm d-none me-1" id="spinOverdue"></span>
                        Analyze Overdue
                    </button>
                    <div id="overdueResults" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- Floor Heatmap - Future Scope -->
        <!-- Removed for now, planned for future release -->

        <!-- Repeat Offenders -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <i class="bi bi-person-exclamation me-2"></i>Repeat Offenders
                </div>
                <div class="card-body">
                    <p class="card-text text-muted">Identify locations and contractors with the most issues.</p>
                    <button class="btn btn-warning" id="btnOffenders" {% if not issues_file %}disabled{% endif %}>
                        <span class="spinner-border spinner-border-sm d-none me-1" id="spinOffenders"></span>
                        Find Offenders
                    </button>
                    <div id="offendersResults" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- Post-Approval Issues -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-purple text-white" style="background: #6f42c1;">
                    <i class="bi bi-check2-square me-2"></i>Post-Approval Issue Detection
                </div>
                <div class="card-body">
                    <p class="card-text text-muted">Flag cases where approved EQC checklists still have issues raised
                        afterward.</p>
                    <button class="btn btn-secondary" id="btnPostApproval" {% if not eqc_file or not issues_file
                        %}disabled{% endif %} style="background: #6f42c1; border-color: #6f42c1;">
                        <span class="spinner-border spinner-border-sm d-none me-1" id="spinPostApproval"></span>
                        Detect Issues
                    </button>
                    <div id="postApprovalResults" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Overdue Issues
        document.getElementById('btnOverdue')?.addEventListener('click', async function () {
            const btn = this;
            const spin = document.getElementById('spinOverdue');
            const results = document.getElementById('overdueResults');

            btn.disabled = true;
            spin.classList.remove('d-none');
            results.innerHTML = '<div class="text-muted">Analyzing...</div>';

            try {
                const resp = await fetch('/api/analytics/overdue-issues', { method: 'POST' });
                const data = await resp.json();

                if (data.error) {
                    results.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                } else {
                    let html = `
                    <div class="alert alert-${data.summary.total_overdue > 0 ? 'danger' : 'success'}">
                        <strong>Overdue:</strong> ${data.summary.total_overdue} / ${data.summary.total_issues_with_deadline}
                        (${data.summary.overdue_percentage}%)
                    </div>
                `;

                    // By Team
                    if (data.by_team && Object.keys(data.by_team).length > 0) {
                        html += '<h6>By Team:</h6><ul class="list-group mb-3">';
                        for (const [team, count] of Object.entries(data.by_team)) {
                            html += `<li class="list-group-item d-flex justify-content-between">
                            <span>${team}</span>
                            <span class="badge bg-danger">${count}</span>
                        </li>`;
                        }
                        html += '</ul>';
                    }

                    // Overdue list
                    if (data.overdue_issues && data.overdue_issues.length > 0) {
                        html += '<h6 class="text-danger">Top Overdue Issues:</h6><div class="table-responsive"><table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Description</th><th>Days</th><th>Team</th><th>Deadline</th></tr></thead><tbody>';
                        for (const issue of data.overdue_issues.slice(0, 10)) {
                            html += `<tr><td>${issue.description}</td><td class="text-danger fw-bold">${issue.days_overdue}</td><td>${issue.assigned_team}</td><td>${issue.deadline}</td></tr>`;
                        }
                        html += '</tbody></table></div>';
                    }

                    results.innerHTML = html;
                }
            } catch (e) {
                results.innerHTML = `<div class="alert alert-danger">Error: ${e.message}</div>`;
            }

            btn.disabled = false;
            spin.classList.add('d-none');
        });

        // Floor Heatmap - Removed (Future Scope)

        // Repeat Offenders
        document.getElementById('btnOffenders')?.addEventListener('click', async function () {
            const btn = this;
            const spin = document.getElementById('spinOffenders');
            const results = document.getElementById('offendersResults');

            btn.disabled = true;
            spin.classList.remove('d-none');
            results.innerHTML = '<div class="text-muted">Analyzing...</div>';

            try {
                const resp = await fetch('/api/analytics/repeat-offenders', { method: 'POST' });
                const data = await resp.json();

                if (data.error) {
                    results.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                } else {
                    let html = '';

                    // By Contractor
                    if (data.by_contractor && data.by_contractor.length > 0) {
                        html += '<h6>Top Contractors (by Issue Count):</h6><div class="table-responsive"><table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Contractor</th><th>Issues</th><th>Closure Rate</th></tr></thead><tbody>';
                        for (const item of data.by_contractor) {
                            const rateColor = item.closure_rate >= 80 ? 'success' : item.closure_rate >= 50 ? 'warning' : 'danger';
                            html += `<tr><td>${item.contractor}</td><td class="fw-bold">${item.count}</td><td><span class="badge bg-${rateColor}">${item.closure_rate}%</span></td></tr>`;
                        }
                        html += '</tbody></table></div>';
                    }

                    // By Location
                    if (data.by_location && data.by_location.length > 0) {
                        html += '<h6 class="mt-3">Top Locations (by Issue Count):</h6><div class="table-responsive"><table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Project</th><th>Location</th><th>Issues</th><th>Closure Rate</th></tr></thead><tbody>';
                        for (const item of data.by_location) {
                            const rateColor = item.closure_rate >= 80 ? 'success' : item.closure_rate >= 50 ? 'warning' : 'danger';
                            html += `<tr><td>${item.project || '-'}</td><td>${item.location}</td><td class="fw-bold">${item.count}</td><td><span class="badge bg-${rateColor}">${item.closure_rate}%</span></td></tr>`;
                        }
                        html += '</tbody></table></div>';
                    }

                    // By Issue Type
                    if (data.by_issue_type && data.by_issue_type.length > 0) {
                        html += '<h6 class="mt-3">By Issue Type:</h6><ul class="list-group">';
                        for (const item of data.by_issue_type) {
                            html += `<li class="list-group-item d-flex justify-content-between"><span>${item.type}</span><span class="badge bg-warning text-dark">${item.count}</span></li>`;
                        }
                        html += '</ul>';
                    }

                    results.innerHTML = html || '<div class="alert alert-info">No data found.</div>';
                }
            } catch (e) {
                results.innerHTML = `<div class="alert alert-danger">Error: ${e.message}</div>`;
            }

            btn.disabled = false;
            spin.classList.add('d-none');
        });

        // Post-Approval Issues
        document.getElementById('btnPostApproval')?.addEventListener('click', async function () {
            const btn = this;
            const spin = document.getElementById('spinPostApproval');
            const results = document.getElementById('postApprovalResults');

            btn.disabled = true;
            spin.classList.remove('d-none');
            results.innerHTML = '<div class="text-muted">Cross-referencing EQC and Issues...</div>';

            try {
                const resp = await fetch('/api/analytics/post-approval-issues', { method: 'POST' });
                const data = await resp.json();

                if (data.error) {
                    results.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                } else {
                    let html = `
                    <div class="alert alert-${data.summary.total_flagged > 0 ? 'warning' : 'success'}">
                        <strong>Flagged Issues:</strong> ${data.summary.total_flagged}
                        (out of ${data.summary.approved_checklists} approved checklists)
                    </div>
                `;

                    if (data.flagged_issues && data.flagged_issues.length > 0) {
                        html += '<h6 class="text-warning">Issues Raised After EQC Approval:</h6><div class="table-responsive"><table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Location</th><th>EQC Type</th><th>Issue Type</th><th>Days After</th><th>Description</th></tr></thead><tbody>';
                        for (const issue of data.flagged_issues.slice(0, 15)) {
                            html += `<tr><td>${issue.location}</td><td>${issue.eqc_type}</td><td>${issue.issue_type}</td><td class="text-danger fw-bold">${issue.days_after}</td><td>${issue.issue_description}</td></tr>`;
                        }
                        html += '</tbody></table></div>';
                    }

                    results.innerHTML = html;
                }
            } catch (e) {
                results.innerHTML = `<div class="alert alert-danger">Error: ${e.message}</div>`;
            }

            btn.disabled = false;
            spin.classList.add('d-none');
        });
    });
</script>
{% endblock %}