{% extends 'base.html' %}
{% block title %}Flat-wise EQC Report{% endblock %}
{% block content %}
<div class="card">
  <div class="card-body">
    <h5 class="card-title">Flat-wise EQC Report</h5>
    <form class="row gy-2 gx-2 align-items-end" method="get" action="{{ url_for('flat_report_index') }}">
      <div class="col-md-3">
        <label class="form-label">EQC file path</label>
        <input class="form-control" type="text" name="path" value="{{ path }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Project</label>
        <select class="form-select" name="project" onchange="this.form.submit()">
          {% for p in projects %}
          <option value="{{ p }}" {% if p==selected_project %}selected{% endif %}>{{ p }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Building</label>
        <select class="form-select" name="building" onchange="this.form.submit()">
          {% for b in buildings %}
          <option value="{{ b }}" {% if b==selected_building %}selected{% endif %}>{{ b }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Floor</label>
        <select class="form-select" name="floor" onchange="this.form.submit()">
          <option value="ALL" {% if selected_floor=='ALL' %}selected{% endif %}>All floors (building-wise)</option>
          {% for f in floors %}
          <option value="{{ f }}" {% if f==selected_floor %}selected{% endif %}>{{ f }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Flat</label>
        <select class="form-select" name="flat" onchange="this.form.submit()">
          <option value="ALL" {% if selected_flat=='ALL' %}selected{% endif %}>All</option>
          {% for fl in flats %}
          <option value="{{ fl }}" {% if fl==selected_flat %}selected{% endif %}>{{ fl }}</option>
          {% endfor %}
        </select>
      </div>
    </form>

    <hr>
    {% if show_only_export %}
    <div class="alert alert-info">All floors selected. Use the Export button to download the building-wise report.</div>
    {% else %}
    {# RCC Table - Floor/Pour Level Checklists #}
    <div class="mb-4">
      <h5 class="text-primary"><i class="bi bi-building me-2"></i>RCC / Structural Checklists (Floor Level)</h5>
      <p class="text-muted small">These checklists apply to the entire floor or pour, not individual flats.</p>
      {% if rcc_items %}
      <table class="table table-sm table-bordered">
        <thead class="table-light">
          <tr>
            <th>Checklist</th>
            <th>Stage</th>
            <th>Status</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
          {% for it in rcc_items %}
          <tr>
            <td>
              {% if it.url %}
              <a href="{{ it.url }}" target="_blank" rel="noopener">{{ it.checklist }}</a>
              {% else %}
              {{ it.checklist }}
              {% endif %}
            </td>
            <td><span class="badge bg-secondary">{{ it.stage }}</span></td>
            <td>
              {% if it.status and it.status|upper == 'PASSED' %}
              <span class="badge bg-success">✓ Passed</span>
              {% elif it.status %}
              <span class="badge bg-info">{{ it.status }}</span>
              {% else %}
              <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td><span class="text-muted small">{{ it.date }}</span></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div class="alert alert-secondary">No RCC/Structural checklists found for this floor.</div>
      {% endif %}
    </div>

    {# Aluform Table - Floor Level Checklists #}
    <div class="mb-4">
      <h5 class="text-warning"><i class="bi bi-gear me-2"></i>Aluform Checklists (Floor Level)</h5>
      <p class="text-muted small">These checklists apply to structural formwork stages.</p>
      {% if aluform_items %}
      <table class="table table-sm table-bordered">
        <thead class="table-light">
          <tr>
            <th>Checklist</th>
            <th>Stage</th>
            <th>Status</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
          {% for it in aluform_items %}
          <tr>
            <td>
              {% if it.url %}
              <a href="{{ it.url }}" target="_blank" rel="noopener">{{ it.checklist }}</a>
              {% else %}
              {{ it.checklist }}
              {% endif %}
            </td>
            <td><span class="badge bg-warning text-dark">{{ it.stage }}</span></td>
            <td>
              {% if it.status and it.status|upper == 'PASSED' %}
              <span class="badge bg-success">✓ Passed</span>
              {% elif it.status %}
              <span class="badge bg-info">{{ it.status }}</span>
              {% else %}
              <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td><span class="text-muted small">{{ it.date }}</span></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div class="alert alert-secondary">No Aluform checklists found for this floor.</div>
      {% endif %}
    </div>

    {# Handover Table - Multiple Level Checklists #}
    <div class="mb-4">
      <h5 class="text-info"><i class="bi bi-check-circle me-2"></i>Handover Checklists</h5>
      <p class="text-muted small">These checklists cover internal handover between stages.</p>
      {% if handover_items %}
      <table class="table table-sm table-bordered">
        <thead class="table-light">
          <tr>
            <th>Checklist</th>
            <th>Stage</th>
            <th>Status</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
          {% for it in handover_items %}
          <tr>
            <td>
              {% if it.url %}
              <a href="{{ it.url }}" target="_blank" rel="noopener">{{ it.checklist }}</a>
              {% else %}
              {{ it.checklist }}
              {% endif %}
            </td>
            <td><span class="badge bg-info">{{ it.stage }}</span></td>
            <td>
              {% if it.status and it.status|upper == 'PASSED' %}
              <span class="badge bg-success">✓ Passed</span>
              {% elif it.status %}
              <span class="badge bg-info">{{ it.status }}</span>
              {% else %}
              <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td><span class="text-muted small">{{ it.date }}</span></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div class="alert alert-secondary">No Handover checklists found for this floor.</div>
      {% endif %}
    </div>

    {# Finishing Table - Flat Level Checklists #}
    <div class="mb-4">
      <h5 class="text-success"><i class="bi bi-house-door me-2"></i>Finishing Checklists (Flat Level)</h5>
      <p class="text-muted small">These checklists apply to individual flats: {{ selected_flat }}</p>
      {% set has_finishing = false %}
      {% for k in ordered_finishing_keys %}
      {% if finishing_items_by_cat.get(k) %}
      {% set has_finishing = true %}
      {% endif %}
      {% endfor %}

      {% if has_finishing %}
      {% for k in ordered_finishing_keys %}
      {% set idx = k[0] %}
      {% set cat = k[1] %}
      {% if finishing_items_by_cat.get(k) %}
      <h6 class="mt-3">{{ cat }}</h6>
      <ul class="list-group mb-3">
        {% for it in finishing_items_by_cat[k] %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            {% if it.status and it.status|upper == 'PASSED' %}
            <span title="Passed" class="me-1 text-success">✓</span>
            {% endif %}
            {% if it.url %}
            <a href="{{ it.url }}" target="_blank" rel="noopener">{{ it.checklist }}</a>
            {% else %}
            {{ it.checklist }}
            {% endif %}
            {% if it.status and it.status|upper != 'PASSED' %}
            <span class="badge text-bg-secondary ms-2">{{ it.stage }}</span>
            <span class="badge text-bg-info ms-1">{{ it.status }}</span>
            {% endif %}
          </div>
          {% if it.date %}
          <span class="text-muted small">{{ it.date }}</span>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
      {% endif %}
      {% endfor %}
      {% else %}
      <div class="alert alert-secondary">No Finishing checklists found for this flat.</div>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>
<div class="mt-3">
  <a class="btn btn-outline-primary"
    href="{{ url_for('flat_report_export', path=path, project=selected_project, building=selected_building, floor=selected_floor) }}">Export
    Excel (status grid)</a>
</div>
{% endblock %}