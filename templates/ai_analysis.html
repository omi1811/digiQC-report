{% extends "base.html" %}
{% block title %}AI Analysis - digiQC Reports{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Hero Banner -->
    <div class="hero mb-4">
        <div class="d-flex align-items-center gap-3">
            <i class="bi bi-robot" style="font-size: 2.5rem;"></i>
            <div>
                <h1 class="h3 mb-1">AI Analysis Dashboard</h1>
                <p class="lead mb-0">Intelligent CSV analysis using local NLP (no API costs)</p>
            </div>
        </div>
    </div>

    <!-- File Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body d-flex align-items-center gap-3">
                    <i class="bi bi-file-earmark-text text-warning" style="font-size: 1.5rem;"></i>
                    <div>
                        <div class="small text-muted">Instructions/Issues File</div>
                        <div class="fw-semibold">{{ issues_file or 'Not uploaded' }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Issues Pattern Analysis -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <i class="bi bi-people me-2"></i>Teams & Assigned Instructions Analysis
                </div>
                <div class="card-body">
                    <p class="card-text text-muted">View top 7-10 assigned teams with most issues and their most repetitive instructions.</p>
                    <button class="btn btn-warning" id="btnIssuesAnalysis" {% if not issues_file %}disabled{% endif %}>
                        <span class="spinner-border spinner-border-sm d-none me-1" id="spinIssues"></span>
                        Run Analysis
                    </button>
                    <div id="issuesResults" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Instructions/Issues Pattern Analysis
        document.getElementById('btnIssuesAnalysis')?.addEventListener('click', async function () {
            const btn = this;
            const spin = document.getElementById('spinIssues');
            const results = document.getElementById('issuesResults');

            btn.disabled = true;
            spin.classList.remove('d-none');
            results.innerHTML = '<div class="text-muted"><i class="bi bi-hourglass-split me-2"></i>Analyzing (this may take up to 30 seconds)...</div>';
            console.log('[DEBUG] Starting fetch request...');

            try {
                // Use 40s timeout on client side (backend has 30s timeout)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    console.log('[DEBUG] Client timeout - aborting request');
                    controller.abort();
                }, 40000);
                
                console.log('[DEBUG] Sending POST to /api/ai/issues-patterns');
                const resp = await fetch('/api/ai/issues-patterns', { 
                    method: 'POST',
                    signal: controller.signal 
                });
                clearTimeout(timeoutId);
                
                console.log(`[DEBUG] Response status: ${resp.status}`);
                console.log(`[DEBUG] Response headers: ${resp.headers.get('content-type')}`);
                
                if (!resp.ok) {
                    console.error(`[DEBUG] HTTP Error: ${resp.status}`);
                    const text = await resp.text();
                    console.error(`[DEBUG] Response body: ${text}`);
                    results.innerHTML = `<div class="alert alert-danger"><strong>HTTP Error ${resp.status}:</strong> Failed to fetch data from server.<br><small>Response: ${text.substring(0, 200)}</small></div>`;
                    btn.disabled = false;
                    spin.classList.add('d-none');
                    return;
                }
                
                let data;
                try {
                    const text = await resp.text();
                    console.log(`[DEBUG] Response text length: ${text.length}`);
                    console.log(`[DEBUG] Response preview: ${text.substring(0, 500)}`);
                    data = JSON.parse(text);
                    console.log('[DEBUG] Successfully parsed JSON');
                    console.log(`[DEBUG] Data keys: ${Object.keys(data)}`);
                    console.log(`[DEBUG] Data.teams length: ${data.teams ? data.teams.length : 'undefined'}`);
                    console.log(`[DEBUG] Full data structure:`, data);
                } catch (parseError) {
                    console.error(`[DEBUG] JSON parse error: ${parseError.message}`);
                    results.innerHTML = `<div class="alert alert-danger"><strong>Parse Error:</strong> Server returned invalid JSON.<br><small>${parseError.message}</small></div>`;
                    btn.disabled = false;
                    spin.classList.add('d-none');
                    return;
                }

                if (data.error) {
                    console.error(`[DEBUG] API returned error: ${data.error}`);
                    let errorHtml = `<div class="alert alert-danger"><strong>Error:</strong> ${data.error}`;
                    if (data.note) {
                        errorHtml += `<br><small>${data.note}</small>`;
                    }
                    errorHtml += '</div>';
                    results.innerHTML = errorHtml;
                } else {
                    let html = '';
                    
                    if (data.note && data.note.trim()) {
                        html += `<div class="alert alert-info small"><i class="bi bi-info-circle me-2"></i>${data.note}</div>`;
                    }

                    // Display teams with their repetitive instructions
                    if (data.teams && data.teams.length > 0) {
                        console.log(`[DEBUG] Displaying ${data.teams.length} teams`);
                        html += '<div class="accordion" id="teamsAccordion">';
                        
                        data.teams.forEach((team, idx) => {
                            // Validate team object has required properties
                            if (!team || typeof team !== 'object') {
                                console.error(`[DEBUG] Invalid team at index ${idx}:`, team);
                                return;
                            }
                            
                            const teamId = `team_${idx}`;
                            const isExpanded = idx === 0;
                            const teamName = team.team || 'Unknown Team';
                            const totalIssues = team.total_issues || 0;
                            
                            console.log(`[DEBUG] Processing team: ${teamName}, issues: ${totalIssues}`);
                            
                            html += `
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button ${!isExpanded ? 'collapsed' : ''}" type="button" 
                                            data-bs-toggle="collapse" data-bs-target="#${teamId}">
                                        <strong>${teamName}</strong>
                                        <span class="badge bg-danger ms-2">${totalIssues} issues</span>
                                    </button>
                                </h2>
                                <div id="${teamId}" class="accordion-collapse collapse ${isExpanded ? 'show' : ''}" 
                                     data-bs-parent="#teamsAccordion">
                                    <div class="accordion-body">
                                        <h6><i class="bi bi-exclamation-circle me-2"></i>Top Repetitive Instructions:</h6>
                                        <ol class="list-group list-group-numbered">`;
                            
                            if (team.top_instructions && Array.isArray(team.top_instructions) && team.top_instructions.length > 0) {
                                team.top_instructions.forEach((instruction, instIdx) => {
                                    const desc = instruction.description || 'Unknown';
                                    const count = instruction.count || 0;
                                    console.log(`[DEBUG] Instruction ${instIdx + 1}: "${desc}" (${count})`);
                                    html += `
                                            <li class="list-group-item d-flex justify-content-between align-items-start">
                                                <span>${desc}</span>
                                                <span class="badge bg-warning text-dark">${count}</span>
                                            </li>`;
                                });
                            } else {
                                console.warn(`[DEBUG] No instructions for team: ${teamName}`);
                                html += `<li class="list-group-item">No instructions found</li>`;
                            }
                            
                            html += `
                                        </ol>
                                    </div>
                                </div>
                            </div>`;
                        });
                        
                        html += '</div>';
                    } else {
                        console.warn('[DEBUG] No teams found in response');
                        html = '<div class="alert alert-secondary">No teams or instructions found.</div>';
                    }

                    results.innerHTML = html;
                }
            } catch (e) {
                console.error(`[DEBUG] Catch block error: ${e.name} - ${e.message}`);
                if (e.name === 'AbortError') {
                    results.innerHTML = `<div class="alert alert-danger"><strong>Timeout Error:</strong> Analysis took too long (exceeded 40 seconds). 
                        <br><small>Try: 1) Upload a smaller file, 2) Check your internet connection, or 3) Try again later</small></div>`;
                } else {
                    results.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${e.message}</div>`;
                }
            }

            btn.disabled = false;
            spin.classList.add('d-none');
        });
    });
</script>
{% endblock %}