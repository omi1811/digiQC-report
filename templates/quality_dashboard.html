{% extends "base.html" %}
{% block title %}Quality Dashboard - digiQC Reports{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="hero">
            <h1 class="h3 mb-1"><i class="bi bi-clipboard-data me-2"></i>Quality Dashboard</h1>
            <p class="lead mb-0">Project-wise Quality Observations & EQC Summary</p>
        </div>
        <div class="text-end">
            <div class="badge bg-primary fs-6">Date: {{ dashboard_date }}</div>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
    {% elif not projects %}
    <div class="alert alert-warning">No data available. Please upload EQC and Issues CSV files first.</div>
    {% else %}

    <!-- Combined Dashboard Table -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-sm align-middle text-center mb-0" style="font-size: 0.85rem;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <th colspan="12" class="text-center py-2">Quality Observation Dashboard</th>
                            <th colspan="4" class="text-center py-2"
                                style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">Quality EQC
                                Dashboard</th>
                        </tr>
                        <tr class="table-light">
                            <th rowspan="2" style="width: 40px;">Sr.No</th>
                            <th rowspan="2" style="min-width: 120px;">Project Name</th>
                            <th rowspan="2" style="width: 70px;">Type</th>
                            <th colspan="3" class="bg-info text-white">Today Observation</th>
                            <th colspan="3" class="bg-warning text-dark">This Month Report</th>
                            <th colspan="3" class="bg-danger text-white">Cumulative Report</th>
                            <th rowspan="2" style="width: 50px;">Type</th>
                            <th style="width: 60px;">Pre</th>
                            <th style="width: 60px;">During</th>
                            <th style="width: 60px;">Post</th>
                        </tr>
                        <tr class="table-light">
                            <th>Raised</th>
                            <th class="text-danger">Open</th>
                            <th class="text-success">Closed</th>
                            <th>Raised</th>
                            <th class="text-danger">Open</th>
                            <th class="text-success">Closed</th>
                            <th>Raised</th>
                            <th class="text-danger">Open</th>
                            <th class="text-success">Closed</th>
                            <th colspan="3"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for proj in projects %}
                        <!-- Internal Row -->
                        <tr>
                            <td rowspan="2" class="fw-bold">{{ loop.index }}</td>
                            <td rowspan="2" class="text-start fw-semibold">{{ proj.name }}</td>
                            <td class="bg-light">Internal</td>
                            <td>{{ proj.observations.internal.today.raised }}</td>
                            <td class="text-danger fw-bold">{{ proj.observations.internal.today.open }}</td>
                            <td class="text-success">{{ proj.observations.internal.today.closed }}</td>
                            <td>{{ proj.observations.internal.month.raised }}</td>
                            <td class="text-danger fw-bold">{{ proj.observations.internal.month.open }}</td>
                            <td class="text-success">{{ proj.observations.internal.month.closed }}</td>
                            <td>{{ proj.observations.internal.cumulative.raised }}</td>
                            <td class="text-danger fw-bold">{{ proj.observations.internal.cumulative.open }}</td>
                            <td class="text-success">{{ proj.observations.internal.cumulative.closed }}</td>
                            <td class="bg-light fw-semibold">Total</td>
                            <td class="table-primary">{{ proj.eqc.total.pre }}</td>
                            <td class="table-warning">{{ proj.eqc.total.during }}</td>
                            <td class="table-success">{{ proj.eqc.total.post }}</td>
                        </tr>
                        <!-- External Row -->
                        <tr>
                            <td class="bg-light">External</td>
                            <td>{{ proj.observations.external.today.raised }}</td>
                            <td class="text-danger fw-bold">{{ proj.observations.external.today.open }}</td>
                            <td class="text-success">{{ proj.observations.external.today.closed }}</td>
                            <td>{{ proj.observations.external.month.raised }}</td>
                            <td class="text-danger fw-bold">{{ proj.observations.external.month.open }}</td>
                            <td class="text-success">{{ proj.observations.external.month.closed }}</td>
                            <td>{{ proj.observations.external.cumulative.raised }}</td>
                            <td class="text-danger fw-bold">{{ proj.observations.external.cumulative.open }}</td>
                            <td class="text-success">{{ proj.observations.external.cumulative.closed }}</td>
                            <td class="bg-light fw-semibold">Today</td>
                            <td class="table-primary">{{ proj.eqc.today.pre }}</td>
                            <td class="table-warning">{{ proj.eqc.today.during }}</td>
                            <td class="table-success">{{ proj.eqc.today.post }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="mt-3 d-flex gap-4 flex-wrap">
        <div><span class="badge bg-info">Today</span> = Today's observations</div>
        <div><span class="badge bg-warning text-dark">Month</span> = This month to date</div>
        <div><span class="badge bg-danger">Cumulative</span> = All-time total</div>
        <div><span class="text-danger fw-bold">Open</span> = Issues still pending</div>
        <div><span class="text-success">Closed</span> = Issues resolved</div>
    </div>

    {% endif %}
</div>
{% endblock %}