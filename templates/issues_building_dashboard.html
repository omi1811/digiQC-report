{% extends 'base.html' %}
{% block title %}Building-wise Issues Dashboard{% endblock %}
{% block content %}
  <a href="{{ url_for('dashboards_page') }}" class="btn btn-outline-secondary btn-sm mb-3"><i class="bi bi-arrow-left"></i> Back to Dashboards</a>
  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title">Building-wise Issues Dashboard</h5>
      <form class="row gy-2 gx-2 align-items-end" method="get" action="{{ url_for('issues_building_dashboard') }}">
        <div class="col-md-5">
          <label class="form-label">Issues file path</label>
          <input class="form-control" type="text" name="path" value="{{ path }}" placeholder="Leave empty to use session or auto-detect">
        </div>
        <div class="col-md-2">
          <label class="form-label">Start date</label>
          <input class="form-control" type="date" name="start" value="{{ start }}">
        </div>
        <div class="col-md-2">
          <label class="form-label">End date</label>
          <input class="form-control" type="date" name="end" value="{{ end }}">
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary" type="submit">Update</button>
        </div>
      </form>
      <form class="row gy-2 gx-2 align-items-end mt-2" method="post" action="{{ url_for('set_issues_external', next=url_for('issues_building_dashboard')) }}">
        <div class="col-md-5">
          <label class="form-label">External Auditor</label>
          <input class="form-control" type="text" name="external_name" id="external_name" value="{{ external_name }}" list="rb_list" placeholder="Type name or leave blank/None">
          <datalist id="rb_list"></datalist>
        </div>
        <div class="col-md-2">
          <button class="btn btn-outline-primary" type="submit">Set External</button>
        </div>
        <div class="col-md-4 small text-muted">Leave blank or enter "None" to treat all as Internal.</div>
      </form>
  <p class="mt-2 text-muted small">Quality issues only (Safety excluded). This page shows Internal and External as separate charts.</p>
    </div>
  </div>

  {% if chart_data %}
    {% for proj, series in chart_data.items() %}
      <div class="card mb-4">
        <div class="card-body">
          <h6 class="card-title">{{ proj }}</h6>
          <div style="height:440px">
            <canvas id="issues_chart_{{ loop.index }}"></canvas>
          </div>
          {% if has_external %}
            <div class="mt-5">
              <h6 class="card-subtitle mb-2 text-muted">External-only focus</h6>
              <div style="height:340px">
                <canvas id="issues_chart_ext_{{ loop.index }}"></canvas>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="alert alert-warning">No data found. Upload an Issues CSV from the navbar or provide a path above.</div>
  {% endif %}

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script id="has-external" type="application/json">{{ has_external | tojson | safe }}</script>
  <script id="issues-chart-data" type="application/json">{{ chart_data | tojson | safe }}</script>
  <script>
    const issuesData = JSON.parse(document.getElementById('issues-chart-data').textContent);
    const HAS_EXTERNAL = JSON.parse(document.getElementById('has-external').textContent);
    let i = 0;
    for (const [proj, s] of Object.entries(issuesData)) {
      i += 1;
      const ctx = document.getElementById('issues_chart_' + i).getContext('2d');
      const data = {
        labels: s.labels,
        datasets: [
          { label: 'Internal Total', data: s.int_total, backgroundColor: '#845ef7', categoryPercentage: 0.7, barPercentage: 1.0, barThickness: 34, maxBarThickness: 48 },
          { label: 'Internal Open', data: s.int_open, backgroundColor: '#ffa94d', categoryPercentage: 0.7, barPercentage: 1.0, barThickness: 34, maxBarThickness: 48 },
          { label: 'Internal Closed', data: s.int_closed, backgroundColor: '#adb5bd', categoryPercentage: 0.7, barPercentage: 1.0, barThickness: 34, maxBarThickness: 48 }
        ]
      };
      new Chart(ctx, {
        type: 'bar',
        data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: { stacked: false, ticks: { color: '#212529', font: { size: 16, weight: '700' } }, grid: { color: '#e9ecef' } },
            y: { beginAtZero: true, ticks: { precision: 0, color: '#212529', font: { size: 16, weight: '700' } }, grid: { color: '#e9ecef' } }
          },
          plugins: { legend: { position: 'top', labels: { color: '#212529', boxWidth: 16, padding: 12, font: { size: 12, weight: '600' } } }, tooltip: { backgroundColor: 'rgba(0,0,0,.85)', titleColor: '#fff', bodyColor: '#fff', borderColor: '#495057', borderWidth: 1 } }
        }
      });
      // External-only focus chart (Total/Open/Closed)
      if (HAS_EXTERNAL) {
        const ctxExt = document.getElementById('issues_chart_ext_' + i).getContext('2d');
      const dataExt = {
        labels: s.labels,
        datasets: [
          { label: 'External Total', data: s.ext_total, backgroundColor: '#339af0', categoryPercentage: 0.9, barPercentage: 1.0, barThickness: 30, maxBarThickness: 44 },
          { label: 'External Open', data: s.ext_open, backgroundColor: '#ff6b6b', categoryPercentage: 0.9, barPercentage: 1.0, barThickness: 30, maxBarThickness: 44 },
          { label: 'External Closed', data: s.ext_closed, backgroundColor: '#20c997', categoryPercentage: 0.9, barPercentage: 1.0, barThickness: 30, maxBarThickness: 44 },
        ]
      };
      new Chart(ctxExt, {
        type: 'bar',
        data: dataExt,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: { stacked: false, ticks: { color: '#212529', font: { size: 16, weight: '700' } }, grid: { color: '#e9ecef' } },
            y: { beginAtZero: true, ticks: { precision: 0, color: '#212529', font: { size: 16, weight: '700' } }, grid: { color: '#e9ecef' } }
          },
          plugins: { legend: { position: 'top', labels: { color: '#212529', boxWidth: 16, padding: 12, font: { size: 12, weight: '600' } } }, tooltip: { backgroundColor: 'rgba(0,0,0,.85)', titleColor: '#fff', bodyColor: '#fff', borderColor: '#495057', borderWidth: 1 } }
        }
      });
      }
    }
  </script>
{% endblock %}

    // Suggestions for External Auditor input
    (function() {
      const inp = document.getElementById('external_name');
      const dl = document.getElementById('rb_list');
      if (!inp || !dl) return;
      let lastQ = '';
      inp.addEventListener('input', async () => {
        const q = inp.value.trim();
        if (q === lastQ) return; lastQ = q;
        try {
          const res = await fetch(`/api/suggest-raised-by?q=${encodeURIComponent(q)}&limit=8`);
          const arr = await res.json();
          dl.innerHTML = '';
          (arr || []).forEach(o => {
            const opt = document.createElement('option');
            opt.value = o.name;
            opt.label = `${o.name} (${o.count})`;
            dl.appendChild(opt);
          });
        } catch (e) { /* ignore */ }
      });
    })();
